from __future__ import annotations

from pathlib import Path
import ast
import json
import os
from typing import Any


def _workspace_root() -> Path:
    workspace = os.getenv("REMORA_WORKSPACE_DIR") or os.getenv("CAIRN_WORKSPACE_DIR")
    return Path(workspace) if workspace else Path.cwd()


def _resolve_target_file() -> Path | None:
    workspace_root = _workspace_root()
    env_path = os.getenv("REMORA_TARGET_FILE")
    if env_path:
        path = Path(env_path)
        return path if path.is_absolute() else workspace_root / path

    hint_path = workspace_root / ".remora" / "target_file"
    if hint_path.exists():
        raw = hint_path.read_text(encoding="utf-8").strip()
        if raw:
            path = Path(raw)
            return path if path.is_absolute() else workspace_root / path

    return None


def _load_node_text() -> str:
    env_text = os.getenv("REMORA_NODE_TEXT")
    if env_text:
        return env_text

    workspace_root = _workspace_root()
    hint_path = workspace_root / ".remora" / "node_text"
    if hint_path.exists():
        return hint_path.read_text(encoding="utf-8")

    target = _resolve_target_file()
    if target and target.exists():
        return target.read_text(encoding="utf-8")

    raise FileNotFoundError("Node text not found for docstring inspection.")


def _find_docstring_node(module: ast.Module) -> ast.AST | None:
    for node in module.body:
        if isinstance(node, (ast.FunctionDef, ast.AsyncFunctionDef, ast.ClassDef)):
            return node
    return None


def run(_: dict[str, Any]) -> dict[str, Any]:
    try:
        source = _load_node_text()
        module = ast.parse(source)
        node = _find_docstring_node(module)
        if node is None:
            raise ValueError("No docstring-capable node found in node text.")

        docstring = ast.get_docstring(node, clean=False)
        return {
            "docstring": docstring,
            "has_docstring": bool(docstring),
        }
    except Exception as exc:  # noqa: BLE001 - tool scripts must never raise
        return {"error": str(exc)}


if __name__ == "__main__":
    payload = json.loads(os.environ.get("REMORA_INPUT", "{}"))
    print(json.dumps(run(payload)))
