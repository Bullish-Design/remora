from __future__ import annotations

from pathlib import Path
import json
import os
import subprocess
from typing import Any


def _workspace_root() -> Path:
    workspace = os.getenv("REMORA_WORKSPACE_DIR") or os.getenv("CAIRN_WORKSPACE_DIR")
    return Path(workspace) if workspace else Path.cwd()


def _resolve_target_file() -> Path:
    workspace_root = _workspace_root()
    env_path = os.getenv("REMORA_TARGET_FILE")
    if env_path:
        path = Path(env_path)
        return path if path.is_absolute() else workspace_root / path

    hint_path = workspace_root / ".remora" / "target_file"
    if hint_path.exists():
        raw = hint_path.read_text(encoding="utf-8").strip()
        if raw:
            path = Path(raw)
            return path if path.is_absolute() else workspace_root / path

    raise FileNotFoundError("Target file not found for linting.")


def _run_command(cmd: list[str]) -> subprocess.CompletedProcess[str]:
    return subprocess.run(cmd, capture_output=True, text=True, check=False)


def run(inputs: dict[str, Any]) -> dict[str, Any]:
    try:
        issue_code = str(inputs.get("issue_code", "")).strip()
        line_number = int(inputs.get("line_number", 0) or 0)
        if not issue_code or line_number <= 0:
            return {"success": False, "message": "issue_code and line_number are required."}

        target_file = _resolve_target_file()
        before = target_file.read_text(encoding="utf-8")

        cmd = ["ruff", "check", "--fix", "--select", issue_code, str(target_file)]
        completed = _run_command(cmd)
        if completed.returncode not in {0, 1}:
            return {"success": False, "message": completed.stderr.strip() or f"ruff exit code {completed.returncode}"}

        after = target_file.read_text(encoding="utf-8")
        if before == after:
            return {"success": False, "message": "No fixable issue at that location"}

        return {"success": True, "message": f"Applied fix for {issue_code} at line {line_number}"}
    except Exception as exc:  # noqa: BLE001 - tool scripts must never raise
        return {"success": False, "message": str(exc)}


if __name__ == "__main__":
    payload = json.loads(os.environ.get("REMORA_INPUT", "{}"))
    print(json.dumps(run(payload)))
