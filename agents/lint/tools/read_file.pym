from __future__ import annotations

from pathlib import Path
import json
import os
from typing import Any


def _workspace_root() -> Path:
    workspace = os.getenv("REMORA_WORKSPACE_DIR") or os.getenv("CAIRN_WORKSPACE_DIR")
    return Path(workspace) if workspace else Path.cwd()


def _resolve_target_file() -> Path:
    workspace_root = _workspace_root()
    env_path = os.getenv("REMORA_TARGET_FILE")
    if env_path:
        path = Path(env_path)
        return path if path.is_absolute() else workspace_root / path

    hint_path = workspace_root / ".remora" / "target_file"
    if hint_path.exists():
        raw = hint_path.read_text(encoding="utf-8").strip()
        if raw:
            path = Path(raw)
            return path if path.is_absolute() else workspace_root / path

    raise FileNotFoundError("Target file not found for linting.")


def _line_count(content: str) -> int:
    if not content:
        return 0
    return len(content.splitlines())


def run(_: dict[str, Any]) -> dict[str, Any]:
    try:
        target_file = _resolve_target_file()
        content = target_file.read_text(encoding="utf-8")
        return {"content": content, "lines": _line_count(content)}
    except Exception as exc:  # noqa: BLE001 - tool scripts must never raise
        return {"error": str(exc)}


if __name__ == "__main__":
    payload = json.loads(os.environ.get("REMORA_INPUT", "{}"))
    print(json.dumps(run(payload)))
